name: Package and Push Helm Chart

on:
    pull_request:
        types: [closed]
#   push:
#     branches:
#       - main

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/chart
  CHART_PATH: ./charts/kubeflex

jobs:
  package-and-push:
    runs-on: ubuntu-latest

    steps:
    - name: Check out code
      uses: actions/checkout@v2

    - name: Set up Helm
      uses: azure/setup-helm@v3
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # - name: Login to registry
    #   uses: docker/login-action@v2
    #   with:
    #     registry: ${{ env.REGISTRY }}
    #     username: ${{ github.actor }}
    #     password: ${{ secrets.TOKEN }}

    - name: Package and push chart
      run: |
        echo ${{ secrets.TOKEN }} | helm registry login ${{ env.REGISTRY }} --username ${{ github.actor }} --password-stdin  
        helm package ${{ env.CHART_PATH }} --destination . --version v0.1.0
        helm push ./*.tgz oci://${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
